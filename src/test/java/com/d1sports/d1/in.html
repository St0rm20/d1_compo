<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Composiciones LoL - Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #0a1428, #001c3b);
            color: #c8aa6e;
            min-height: 100vh;
        }
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: rgba(1, 10, 19, 0.9);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(200, 170, 110, 0.3);
            border: 1px solid #463714;
        }
        .main-container {
            background: rgba(1, 10, 19, 0.95);
            min-height: 100vh;
            padding: 20px;
        }
        .navbar-custom {
            background: linear-gradient(to right, #091428, #0a1428);
            border-bottom: 2px solid #c8aa6e;
        }
        .card-custom {
            background: rgba(1, 10, 19, 0.8);
            border: 1px solid #463714;
            border-radius: 8px;
            transition: transform 0.2s;
        }
        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(200, 170, 110, 0.2);
        }
        .champion-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #c8aa6e;
            margin-right: 5px;
            object-fit: cover;
        }
        .champion-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #c8aa6e;
            margin-right: 3px;
            object-fit: cover;
        }
        .lane-title {
            color: #c8aa6e;
            font-weight: bold;
            margin-bottom: 5px;
            border-bottom: 1px solid #463714;
            padding-bottom: 5px;
        }
        .btn-gold {
            background: linear-gradient(to bottom, #c8aa6e, #785a28);
            color: #000;
            font-weight: bold;
            border: none;
        }
        .btn-gold:hover {
            background: linear-gradient(to bottom, #f0e6d2, #c8aa6e);
            color: #000;
        }
        .search-box {
            background: rgba(1, 10, 19, 0.8);
            border: 1px solid #463714;
            color: #c8aa6e;
        }
        .search-box:focus {
            background: rgba(1, 10, 19, 0.9);
            border-color: #c8aa6e;
            box-shadow: 0 0 10px rgba(200, 170, 110, 0.5);
            color: #f0e6d2;
        }
        .pagination-custom .page-link {
            background-color: #091428;
            border-color: #463714;
            color: #c8aa6e;
        }
        .pagination-custom .page-item.active .page-link {
            background-color: #c8aa6e;
            border-color: #c8aa6e;
            color: #000;
        }
        .modal-content {
            background: #091428;
            border: 2px solid #c8aa6e;
            color: #c8aa6e;
        }
        .form-control-custom {
            background: rgba(1, 10, 19, 0.8);
            border: 1px solid #463714;
            color: #c8aa6e;
        }
        .form-control-custom:focus {
            background: rgba(1, 10, 19, 0.9);
            border-color: #c8aa6e;
            box-shadow: 0 0 10px rgba(200, 170, 110, 0.5);
            color: #f0e6d2;
        }
        .suggestion-box {
            position: absolute;
            background: #091428;
            border: 1px solid #463714;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            display: none;
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #463714;
        }
        .suggestion-item:hover {
            background: #0a1428;
        }
        .password-toggle {
            cursor: pointer;
        }
        .error-message {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .debug-panel {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #463714;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1000;
            font-weight: bold;
        }
        .status-online {
            background-color: #198754;
            color: white;
        }
        .status-offline {
            background-color: #dc3545;
            color: white;
        }
        .status-demo {
            background-color: #ffc107;
            color: black;
        }
    </style>
</head>
<body>
<!-- Indicador de estado de conexión -->
<div id="connection-status" class="connection-status d-none">
    <i class="fas fa-circle me-1"></i>
    <span id="status-text">Conectado</span>
</div>

<!-- Pantalla de autenticación -->
<div id="auth-section" class="auth-container">
    <div class="text-center mb-4">
        <img src="logo.png" alt="LoL Logo" width="150">
        <h2 class="mt-3">Composiciones LoL</h2>
        <p class="text-muted">Ingrese la contraseña para continuar</p>
    </div>
    <div class="mb-3">
        <div class="input-group">
            <input type="password" id="password" class="form-control form-control-custom" placeholder="Contraseña" value="d1tupapa">
            <span class="input-group-text password-toggle" id="togglePassword">
                    <i class="fas fa-eye"></i>
                </span>
        </div>
    </div>
    <button id="login-btn" class="btn btn-gold w-100" onclick="authenticate()">
        <i class="fas fa-sign-in-alt me-2"></i>Acceder
    </button>
    <div id="auth-error" class="alert alert-danger mt-3 d-none"></div>

    <!-- Información de conexión -->
    <div class="alert alert-info mt-3">
        <i class="fas fa-info-circle me-2"></i>
        <small>Si el backend no está disponible, la aplicación funcionará en modo demostración.</small>
    </div>
</div>

<!-- Aplicación principal -->
<div id="app" class="d-none">
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="logo.png" alt="LoL Logo" width="30" height="30" class="d-inline-block align-text-top me-2">
                Composiciones LoL
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-home me-1"></i>Inicio</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <input id="search-input" class="form-control me-2 search-box" type="search" placeholder="Buscar composición...">
                    <button class="btn btn-gold" onclick="loadCompositions(0)">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <button class="btn btn-outline-warning ms-3" onclick="showCreateForm()">
                    <i class="fas fa-plus me-1"></i>Nueva Composición
                </button>
                <button class="btn btn-outline-light ms-2" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="container-fluid">
            <div id="demo-alert" class="alert alert-warning d-none">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Modo demostración:</strong> El backend no está disponible. Los datos se guardarán localmente.
            </div>

            <h2 class="mb-4">Composiciones Guardadas</h2>

            <div id="compositions-list" class="row">
                <!-- Las composiciones se cargarán aquí -->
            </div>

            <div class="d-flex justify-content-center mt-4">
                <nav>
                    <ul id="pagination" class="pagination pagination-custom">
                        <!-- La paginación se generará aquí -->
                    </ul>
                </nav>
            </div>

            <!-- Panel de depuración (solo visible en desarrollo) -->
            <div class="debug-panel mt-4 d-none" id="debug-panel">
                <h6>Información de Depuración</h6>
                <div id="debug-content"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar composición -->
<div class="modal fade" id="compositionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Nueva Composición</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="compositionForm">
                    <input type="hidden" id="compositionId">
                    <div class="mb-3">
                        <label for="title" class="form-label">Título de la composición *</label>
                        <input type="text" class="form-control form-control-custom" id="title" required>
                        <div class="error-message" id="title-error"></div>
                    </div>

                    <div class="mb-3">
                        <label for="observations" class="form-label">Observaciones</label>
                        <textarea class="form-control form-control-custom" id="observations" rows="3"></textarea>
                    </div>

                    <h5 class="mt-4 mb-3">Líneas de la composición *</h5>
                    <p class="text-muted">Selecciona al menos un campeón para cada línea</p>

                    <div id="lanes-container">
                        <!-- Las líneas se generarán aquí -->
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-gold mt-3">
                            <i class="fas fa-save me-1"></i>Guardar Composición
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Configuración
    const API_BASE = 'http://localhost:8080/api';
    const PAGE_SIZE = 10;
    let currentPage = 0;
    let totalPages = 0;
    let isAuthenticated = false;
    let authToken = '';
    let championsList = [];
    let backendAvailable = false;
    let demoMode = false;
    let demoCompositions = [];

    // Elementos del DOM
    const authSection = document.getElementById('auth-section');
    const app = document.getElementById('app');
    const authError = document.getElementById('auth-error');
    const compositionsList = document.getElementById('compositions-list');
    const pagination = document.getElementById('pagination');
    const compositionModal = new bootstrap.Modal(document.getElementById('compositionModal'));
    const compositionForm = document.getElementById('compositionForm');
    const modalTitle = document.getElementById('modalTitle');
    const lanesContainer = document.getElementById('lanes-container');
    const searchInput = document.getElementById('search-input');
    const passwordInput = document.getElementById('password');
    const togglePassword = document.getElementById('togglePassword');
    const debugPanel = document.getElementById('debug-panel');
    const debugContent = document.getElementById('debug-content');
    const connectionStatus = document.getElementById('connection-status');
    const statusText = document.getElementById('status-text');
    const demoAlert = document.getElementById('demo-alert');

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar si ya estamos autenticados
        const savedToken = localStorage.getItem('lolAuthToken');
        if (savedToken) {
            authToken = savedToken;
            isAuthenticated = true;
            checkBackendConnection();
        }

        // Configurar evento para búsqueda en tiempo real
        searchInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                loadCompositions(0);
            }
        });

        // Configurar evento para mostrar/ocultar contraseña
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.querySelector('i').classList.toggle('fa-eye');
            this.querySelector('i').classList.toggle('fa-eye-slash');
        });

        // Cargar lista de campeones
        loadChampions();

        // Configurar envío del formulario
        compositionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveComposition();
        });

        // Mostrar panel de depuración en desarrollo
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            debugPanel.classList.remove('d-none');
        }
    });

    // Función para verificar la conexión con el backend
    async function checkBackendConnection() {
        try {
            logDebug('Verificando conexión con el backend...');
            const response = await fetch(`${API_BASE}/compositions/auth`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password: 'd1tupapa' }),
                signal: AbortSignal.timeout(5000) // Timeout de 5 segundos
            });

            if (response.ok) {
                backendAvailable = true;
                demoMode = false;
                updateConnectionStatus('online', 'Conectado al backend');
                showApp();
                logDebug('Conexión con el backend establecida');
            } else {
                backendAvailable = false;
                demoMode = true;
                updateConnectionStatus('demo', 'Modo demostración');
                showApp();
                logDebug('El backend no está disponible, activando modo demostración');
            }
        } catch (error) {
            backendAvailable = false;
            demoMode = true;
            updateConnectionStatus('offline', 'Error de conexión - Modo demostración');
            showApp();
            logDebug(`Error de conexión: ${error.message}. Activando modo demostración`);
        }
    }

    // Función para actualizar el indicador de estado de conexión
    function updateConnectionStatus(status, message) {
        connectionStatus.classList.remove('d-none', 'status-online', 'status-offline', 'status-demo');

        if (status === 'online') {
            connectionStatus.classList.add('status-online');
            demoAlert.classList.add('d-none');
        } else if (status === 'demo') {
            connectionStatus.classList.add('status-demo');
            demoAlert.classList.remove('d-none');
        } else {
            connectionStatus.classList.add('status-offline');
            demoAlert.classList.remove('d-none');
        }

        statusText.textContent = message;
    }

    // Función para registrar mensajes de depuración
    function logDebug(message) {
        if (debugPanel.classList.contains('d-none')) return;

        const timestamp = new Date().toLocaleTimeString();
        debugContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        debugContent.scrollTop = debugContent.scrollHeight;
    }

    // Función de autenticación
    async function authenticate() {
        const password = document.getElementById('password').value;

        try {
            logDebug(`Intentando autenticar con contraseña: ${password}`);
            const response = await fetch(`${API_BASE}/compositions/auth`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password }),
                signal: AbortSignal.timeout(5000) // Timeout de 5 segundos
            });

            const result = await response.json();
            logDebug(`Respuesta de autenticación: ${JSON.stringify(result)}`);

            if (result.authenticated) {
                isAuthenticated = true;
                authToken = password;
                localStorage.setItem('lolAuthToken', authToken);
                backendAvailable = true;
                demoMode = false;
                updateConnectionStatus('online', 'Conectado al backend');
                authError.classList.add('d-none');
                showApp();
                logDebug('Autenticación exitosa');
            } else {
                showAuthError('Contraseña incorrecta');
                logDebug('Autenticación fallida: contraseña incorrecta');
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                logDebug('Timeout de conexión al backend');
                showAuthError('El backend no responde. Se activará el modo demostración.');

                // Esperar un momento y luego activar modo demo
                setTimeout(() => {
                    isAuthenticated = true;
                    authToken = password;
                    localStorage.setItem('lolAuthToken', authToken);
                    backendAvailable = false;
                    demoMode = true;
                    updateConnectionStatus('demo', 'Modo demostración');
                    authError.classList.add('d-none');
                    showApp();
                }, 2000);
            } else {
                showAuthError('Error de conexión');
                logDebug(`Error de conexión: ${error.message}`);
            }
        }
    }

    // Función para cerrar sesión
    function logout() {
        isAuthenticated = false;
        authToken = '';
        localStorage.removeItem('lolAuthToken');
        authSection.classList.remove('d-none');
        app.classList.add('d-none');
        passwordInput.value = 'd1tupapa';
        connectionStatus.classList.add('d-none');
        demoAlert.classList.add('d-none');
        logDebug('Sesión cerrada');
    }

    // Mostrar aplicación principal
    function showApp() {
        authSection.classList.add('d-none');
        app.classList.remove('d-none');
        loadCompositions(0);
    }

    // Mostrar error de autenticación
    function showAuthError(message) {
        authError.textContent = message;
        authError.classList.remove('d-none');
    }

    // Cargar composiciones
    async function loadCompositions(page) {
        if (!isAuthenticated) return;

        const searchTerm = searchInput.value;
        currentPage = page;

        // Si estamos en modo demostración, cargar datos locales
        if (demoMode) {
            logDebug('Cargando composiciones en modo demostración');
            loadDemoCompositions(searchTerm, page);
            return;
        }

        // Intentar cargar desde el backend
        try {
            let url = `${API_BASE}/compositions?page=${page}&size=${PAGE_SIZE}`;
            if (searchTerm) {
                url += `&search=${encodeURIComponent(searchTerm)}`;
            }

            logDebug(`Cargando composiciones: ${url}`);
            const response = await fetch(url, {
                headers: {
                    'Authorization': authToken
                },
                signal: AbortSignal.timeout(5000) // Timeout de 5 segundos
            });

            if (response.ok) {
                const data = await response.json();
                logDebug(`Composiciones cargadas: ${data.content.length} elementos`);
                renderCompositions(data.content);
                renderPagination(data.totalPages, page);
            } else if (response.status === 401) {
                logout();
            } else {
                logDebug(`Error al cargar composiciones: ${response.status} ${response.statusText}`);
                // Cambiar a modo demostración si el backend falla
                demoMode = true;
                updateConnectionStatus('demo', 'Modo demostración (fallback)');
                loadDemoCompositions(searchTerm, page);
            }
        } catch (error) {
            logDebug(`Error al cargar composiciones: ${error.message}`);
            // Cambiar a modo demostración si hay error de conexión
            demoMode = true;
            updateConnectionStatus('demo', 'Modo demostración (fallback)');
            loadDemoCompositions(searchTerm, page);
        }
    }

    // Cargar composiciones de demostración
    function loadDemoCompositions(searchTerm, page) {
        // Cargar datos de localStorage o usar datos de ejemplo
        const savedCompositions = localStorage.getItem('demoCompositions');
        if (savedCompositions) {
            demoCompositions = JSON.parse(savedCompositions);
        } else {
            // Datos de ejemplo para demostración
            demoCompositions = [
                {
                    id: 1,
                    title: "Composición de Ejemplo",
                    observations: "Esta es una composición de demostración",
                    lines: [
                        {
                            laneType: "TOP",
                            options: [{ champion: { id: 1, name: "Garen", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Garen.png" } }]
                        },
                        {
                            laneType: "JG",
                            options: [{ champion: { id: 2, name: "Lee Sin", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/LeeSin.png" } }]
                        },
                        {
                            laneType: "MID",
                            options: [{ champion: { id: 3, name: "Ahri", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Ahri.png" } }]
                        },
                        {
                            laneType: "ADC",
                            options: [{ champion: { id: 4, name: "Jinx", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Jinx.png" } }]
                        },
                        {
                            laneType: "SUPP",
                            options: [{ champion: { id: 5, name: "Thresh", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Thresh.png" } }]
                        }
                    ]
                }
            ];
        }

        // Filtrar por término de búsqueda si existe
        let filteredCompositions = demoCompositions;
        if (searchTerm) {
            filteredCompositions = demoCompositions.filter(comp =>
                comp.title.toLowerCase().includes(searchTerm.toLowerCase())
            );
        }

        // Paginación simple para modo demo
        const startIndex = page * PAGE_SIZE;
        const endIndex = startIndex + PAGE_SIZE;
        const paginatedCompositions = filteredCompositions.slice(startIndex, endIndex);
        totalPages = Math.ceil(filteredCompositions.length / PAGE_SIZE);

        renderCompositions(paginatedCompositions);
        renderPagination(totalPages, page);
    }

    // Renderizar composiciones
    function renderCompositions(compositions) {
        if (compositions.length === 0) {
            compositionsList.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                        <h4>No se encontraron composiciones</h4>
                        <p>Utilice el botón "Nueva Composición" para crear una.</p>
                    </div>
                `;
            return;
        }

        compositionsList.innerHTML = compositions.map(comp => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card card-custom h-100">
                        <div class="card-body">
                            <h5 class="card-title">${comp.title}</h5>
                            <p class="card-text">${comp.observations || 'Sin observaciones'}</p>

                            ${comp.lines ? comp.lines.map(line => `
                                <div class="mb-2">
                                    <div class="lane-title">${line.laneType}</div>
                                    <div>
                                        ${line.options ? line.options.map(opt => `
                                            <img src="${opt.champion.imageUrl}" alt="${opt.champion.name}"
                                                 class="champion-img" title="${opt.champion.name}">
                                        `).join('') : 'Sin opciones'}
                                    </div>
                                </div>
                            `).join('') : ''}
                        </div>
                        <div class="card-footer bg-transparent border-top-0">
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm btn-outline-warning me-2" onclick="editComposition(${comp.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteComposition(${comp.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
    }

    // Renderizar paginación
    function renderPagination(totalPages, currentPage) {
        let paginationHTML = '';

        if (currentPage > 0) {
            paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadCompositions(${currentPage - 1})">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                `;
        }

        // Mostrar máximo 5 páginas en la paginación
        const startPage = Math.max(0, currentPage - 2);
        const endPage = Math.min(totalPages, startPage + 5);

        for (let i = startPage; i < endPage; i++) {
            paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadCompositions(${i})">${i + 1}</a>
                    </li>
                `;
        }

        if (currentPage < totalPages - 1) {
            paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadCompositions(${currentPage + 1})">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                `;
        }

        pagination.innerHTML = paginationHTML;
    }

    // Cargar lista de campeones
    async function loadChampions() {
        try {
            logDebug('Cargando lista de campeones...');
            const response = await fetch(`${API_BASE}/compositions/champions`, {
                signal: AbortSignal.timeout(5000) // Timeout de 5 segundos
            });
            championsList = await response.json();
            logDebug(`Lista de campeones cargada: ${championsList.length} campeones`);
        } catch (error) {
            logDebug(`Error al cargar campeones: ${error.message}`);
            // Usar datos de ejemplo si la API no está disponible
            championsList = [
                { id: 1, name: "Ahri", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Ahri.png" },
                { id: 2, name: "Yasuo", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Yasuo.png" },
                { id: 3, name: "Lux", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Lux.png" },
                { id: 4, name: "Zed", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Zed.png" },
                { id: 5, name: "Jinx", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Jinx.png" },
                { id: 6, name: "Garen", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Garen.png" },
                { id: 7, name: "Lee Sin", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/LeeSin.png" },
                { id: 8, name: "Thresh", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Thresh.png" },
                { id: 9, name: "Darius", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Darius.png" },
                { id: 10, name: "Ezreal", imageUrl: "https://ddragon.leagueoflegends.com/cdn/13.15.1/img/champion/Ezreal.png" }
            ];
            logDebug('Usando datos de ejemplo para campeones');
        }
    }

    // Mostrar formulario para crear composición
    function showCreateForm() {
        if (!isAuthenticated) {
            showAuthError('Debe autenticarse primero');
            return;
        }

        modalTitle.textContent = 'Nueva Composición';
        document.getElementById('compositionId').value = '';
        document.getElementById('title').value = '';
        document.getElementById('observations').value = '';
        document.getElementById('title-error').textContent = '';

        // Generar campos para las líneas
        const lanes = ['TOP', 'JG', 'MID', 'ADC', 'SUPP'];
        lanesContainer.innerHTML = lanes.map(lane => `
                <div class="mb-3">
                    <label class="form-label">${lane}</label>
                    <div class="position-relative">
                        <input type="text" class="form-control form-control-custom mb-2 champion-search"
                               data-lane="${lane}" placeholder="Buscar campeón..."
                               oninput="showChampionSuggestions('${lane}', this.value)">
                        <div class="suggestion-box" id="suggestions-${lane}"></div>
                    </div>
                    <div class="selected-champions" id="selected-${lane}"></div>
                    <div class="error-message" id="${lane}-error"></div>
                </div>
            `).join('');

        compositionModal.show();

        // Inicializar eventos de búsqueda
        document.querySelectorAll('.champion-search').forEach(input => {
            input.addEventListener('blur', function() {
                setTimeout(() => {
                    document.getElementById(`suggestions-${this.dataset.lane}`).style.display = 'none';
                }, 200);
            });
        });

        logDebug('Formulario de creación mostrado');
    }

    // Mostrar sugerencias de campeones
    function showChampionSuggestions(lane, query) {
        const suggestionsBox = document.getElementById(`suggestions-${lane}`);

        if (!query) {
            suggestionsBox.style.display = 'none';
            return;
        }

        const filteredChampions = championsList.filter(champ =>
            champ.name.toLowerCase().includes(query.toLowerCase())
        );

        if (filteredChampions.length === 0) {
            suggestionsBox.style.display = 'none';
            return;
        }

        suggestionsBox.innerHTML = filteredChampions.map(champ => `
                <div class="suggestion-item" onclick="selectChampion('${lane}', ${champ.id}, '${champ.name}', '${champ.imageUrl}')">
                    <img src="${champ.imageUrl}" class="champion-small me-2" alt="${champ.name}">
                    ${champ.name}
                </div>
            `).join('');

        suggestionsBox.style.display = 'block';
    }

    // Seleccionar campeón para una línea
    function selectChampion(lane, championId, championName, championImage) {
        const selectedContainer = document.getElementById(`selected-${lane}`);
        const suggestionsBox = document.getElementById(`suggestions-${lane}`);
        const searchInput = document.querySelector(`.champion-search[data-lane="${lane}"]`);
        const errorElement = document.getElementById(`${lane}-error`);

        // Ocultar sugerencias y limpiar búsqueda
        suggestionsBox.style.display = 'none';
        searchInput.value = '';
        errorElement.textContent = '';

        // Verificar si ya se seleccionaron 5 campeones
        if (selectedContainer.children.length >= 5) {
            errorElement.textContent = 'Máximo 5 campeones por línea';
            return;
        }

        // Verificar si el campeón ya fue seleccionado
        if (document.querySelector(`#selected-${lane} .champion-${championId}`)) {
            errorElement.textContent = 'Este campeón ya fue seleccionado para esta línea';
            return;
        }

        // Añadir campeón seleccionado
        selectedContainer.innerHTML += `
                <div class="d-inline-block me-2 mb-2 position-relative champion-${championId}">
                    <img src="${championImage}" class="champion-small" alt="${championName}" title="${championName}">
                    <input type="hidden" name="${lane}-champions" value="${championId}">
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                          style="cursor: pointer; font-size: 0.5rem;"
                          onclick="removeChampion(this, '${lane}', ${championId})">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            `;

        logDebug(`Campeón ${championName} seleccionado para la línea ${lane}`);
    }

    // Remover campeón seleccionado
    function removeChampion(element, lane, championId) {
        element.closest(`.champion-${championId}`).remove();
        document.getElementById(`${lane}-error`).textContent = '';
        logDebug(`Campeón ${championId} removido de la línea ${lane}`);
    }

    // Validar formulario antes de guardar
    function validateForm() {
        let isValid = true;
        const title = document.getElementById('title').value;
        const titleError = document.getElementById('title-error');

        // Validar título
        if (!title.trim()) {
            titleError.textContent = 'El título es obligatorio';
            isValid = false;
        } else {
            titleError.textContent = '';
        }

        // Validar que cada línea tenga al menos un campeón
        const lanes = ['TOP', 'JG', 'MID', 'ADC', 'SUPP'];
        lanes.forEach(lane => {
            const errorElement = document.getElementById(`${lane}-error`);
            const selectedCount = document.querySelectorAll(`#selected-${lane} .champion-small`).length;

            if (selectedCount === 0) {
                errorElement.textContent = 'Selecciona al menos un campeón';
                isValid = false;
            } else {
                errorElement.textContent = '';
            }
        });

        return isValid;
    }

    // Guardar composición
    async function saveComposition() {
        if (!validateForm()) {
            logDebug('Validación de formulario fallida');
            return;
        }

        const compositionId = document.getElementById('compositionId').value;
        const title = document.getElementById('title').value;
        const observations = document.getElementById('observations').value;

        // Recopilar datos de las líneas
        const lanes = ['TOP', 'JG', 'MID', 'ADC', 'SUPP'];
        const lines = [];

        lanes.forEach(lane => {
            const championElements = document.querySelectorAll(`input[name="${lane}-champions"]`);
            if (championElements.length > 0) {
                const options = Array.from(championElements).map((input, index) => ({
                    championId: parseInt(input.value),
                    order: index + 1
                }));

                lines.push({
                    laneType: lane,
                    options: options
                });
            }
        });

        const compositionData = {
            title: title,
            observations: observations,
            lines: lines
        };

        logDebug(`Enviando datos: ${JSON.stringify(compositionData)}`);

        // Si estamos en modo demostración, guardar localmente
        if (demoMode) {
            saveDemoComposition(compositionData, compositionId);
            return;
        }

        // Intentar guardar en el backend
        try {
            const url = compositionId ? `${API_BASE}/compositions/${compositionId}` : `${API_BASE}/compositions`;
            const method = compositionId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': authToken
                },
                body: JSON.stringify(compositionData),
                signal: AbortSignal.timeout(10000) // Timeout de 10 segundos
            });

            if (response.ok) {
                const result = await response.json();
                compositionModal.hide();
                loadCompositions(currentPage);
                logDebug('Composición guardada exitosamente');
            } else if (response.status === 401) {
                logout();
            } else {
                const errorText = await response.text();
                logDebug(`Error al guardar: ${response.status} - ${errorText}`);
                alert('Error al guardar la composición. Verifique la consola para más detalles.');
            }
        } catch (error) {
            logDebug(`Error de conexión: ${error.message}`);

            // Preguntar al usuario si quiere guardar en modo demostración
            if (confirm('Error de conexión al backend. ¿Desea guardar la composición localmente en modo demostración?')) {
                demoMode = true;
                updateConnectionStatus('demo', 'Modo demostración (fallback)');
                saveDemoComposition(compositionData, compositionId);
            }
        }
    }

    // Guardar composición en modo demostración
    function saveDemoComposition(compositionData, compositionId) {
        try {
            if (compositionId) {
                // Editar composición existente
                const index = demoCompositions.findIndex(comp => comp.id == compositionId);
                if (index !== -1) {
                    demoCompositions[index] = {
                        ...compositionData,
                        id: compositionId,
                        lines: compositionData.lines.map(line => ({
                            ...line,
                            options: line.options.map(opt => ({
                                ...opt,
                                champion: championsList.find(c => c.id === opt.championId)
                            }))
                        }))
                    };
                }
            } else {
                // Crear nueva composición
                const newId = demoCompositions.length > 0 ? Math.max(...demoCompositions.map(c => c.id)) + 1 : 1;
                demoCompositions.push({
                    ...compositionData,
                    id: newId,
                    lines: compositionData.lines.map(line => ({
                        ...line,
                        options: line.options.map(opt => ({
                            ...opt,
                            champion: championsList.find(c => c.id === opt.championId)
                        }))
                    }))
                });
            }

            // Guardar en localStorage
            localStorage.setItem('demoCompositions', JSON.stringify(demoCompositions));

            compositionModal.hide();
            loadCompositions(currentPage);
            logDebug('Composición guardada en modo demostración');
        } catch (error) {
            logDebug(`Error al guardar en modo demostración: ${error.message}`);
            alert('Error al guardar la composición en modo demostración.');
        }
    }

    // Editar composición
    async function editComposition(id) {
        // Si estamos en modo demostración, cargar desde datos locales
        if (demoMode) {
            const composition = demoCompositions.find(comp => comp.id == id);
            if (composition) {
                showEditForm(composition);
            } else {
                alert('Composición no encontrada');
            }
            return;
        }

        // Intentar cargar desde el backend
        try {
            logDebug(`Cargando composición para editar: ${id}`);
            const response = await fetch(`${API_BASE}/compositions/${id}`, {
                headers: {
                    'Authorization': authToken
                },
                signal: AbortSignal.timeout(5000) // Timeout de 5 segundos
            });

            if (response.ok) {
                const composition = await response.json();
                logDebug(`Composición cargada: ${JSON.stringify(composition)}`);
                showEditForm(composition);
            } else if (response.status === 401) {
                logout();
            } else {
                logDebug(`Error al cargar composición: ${response.status}`);
                alert('Error al cargar la composición para editar');
            }
        } catch (error) {
            logDebug(`Error al cargar composición: ${error.message}`);
            alert('Error al cargar la composición para editar');
        }
    }

    // Mostrar formulario de edición
    function showEditForm(composition) {
        modalTitle.textContent = 'Editar Composición';
        document.getElementById('compositionId').value = composition.id;
        document.getElementById('title').value = composition.title;
        document.getElementById('observations').value = composition.observations || '';

        // Generar campos para las líneas
        const lanes = ['TOP', 'JG', 'MID', 'ADC', 'SUPP'];
        lanesContainer.innerHTML = lanes.map(lane => {
            const line = composition.lines.find(l => l.laneType === lane);
            const champions = line ? line.options.map(opt => opt.champion) : [];

            return `
                    <div class="mb-3">
                        <label class="form-label">${lane}</label>
                        <div class="position-relative">
                            <input type="text" class="form-control form-control-custom mb-2 champion-search"
                                   data-lane="${lane}" placeholder="Buscar campeón..."
                                   oninput="showChampionSuggestions('${lane}', this.value)">
                            <div class="suggestion-box" id="suggestions-${lane}"></div>
                        </div>
                        <div class="selected-champions" id="selected-${lane}">
                            ${champions.map(champ => `
                                <div class="d-inline-block me-2 mb-2 position-relative champion-${champ.id}">
                                    <img src="${champ.imageUrl}" class="champion-small" alt="${champ.name}" title="${champ.name}">
                                    <input type="hidden" name="${lane}-champions" value="${champ.id}">
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                          style="cursor: pointer; font-size: 0.5rem;"
                                          onclick="removeChampion(this, '${lane}', ${champ.id})">
                                        <i class="fas fa-times"></i>
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="error-message" id="${lane}-error"></div>
                    </div>
                `;
        }).join('');

        compositionModal.show();

        // Inicializar eventos de búsqueda
        document.querySelectorAll('.champion-search').forEach(input => {
            input.addEventListener('blur', function() {
                setTimeout(() => {
                    document.getElementById(`suggestions-${this.dataset.lane}`).style.display = 'none';
                }, 200);
            });
        });
    }

    // Eliminar composición
    async function deleteComposition(id) {
        if (!confirm('¿Está seguro de que desea eliminar esta composición?')) {
            return;
        }

        // Si estamos en modo demostración, eliminar localmente
        if (demoMode) {
            demoCompositions = demoCompositions.filter(comp => comp.id != id);
            localStorage.setItem('demoCompositions', JSON.stringify(demoCompositions));
            loadCompositions(currentPage);
            logDebug('Composición eliminada en modo demostración');
            return;
        }

        // Intentar eliminar en el backend
        try {
            logDebug(`Eliminando composición: ${id}`);
            const response = await fetch(`${API_BASE}/compositions/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': authToken
                },
                signal: AbortSignal.timeout(5000) // Timeout de 5 segundos
            });

            if (response.ok) {
                loadCompositions(currentPage);
                logDebug('Composición eliminada exitosamente');
            } else if (response.status === 401) {
                logout();
            } else {
                logDebug(`Error al eliminar: ${response.status}`);
                alert('Error al eliminar la composición');
            }
        } catch (error) {
            logDebug(`Error al eliminar: ${error.message}`);
            alert('Error al eliminar la composición');
        }
    }
</script>
</body>
</html>